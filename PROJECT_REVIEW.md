# Apple Music Downloader é¡¹ç›®å…¨é¢å¤ç›˜æŠ¥å‘Š

## ğŸ“‹ ç›®å½•
1. [é¡¹ç›®æ¦‚è§ˆ](#é¡¹ç›®æ¦‚è§ˆ)
2. [æ ¸å¿ƒæµç¨‹åˆ†æ](#æ ¸å¿ƒæµç¨‹åˆ†æ)
3. [æ¶æ„åˆç†æ€§è¯„ä¼°](#æ¶æ„åˆç†æ€§è¯„ä¼°)
4. [å‘ç°çš„é—®é¢˜ä¸ä¼˜åŒ–](#å‘ç°çš„é—®é¢˜ä¸ä¼˜åŒ–)
5. [æ½œåœ¨é£é™©ç‚¹](#æ½œåœ¨é£é™©ç‚¹)
6. [ä¼˜åŒ–å»ºè®®](#ä¼˜åŒ–å»ºè®®)
7. [æ€»ç»“](#æ€»ç»“)

---

## 1. é¡¹ç›®æ¦‚è§ˆ

### 1.1 é¡¹ç›®å®šä½
Apple Music æ— æŸéŸ³ä¹ä¸‹è½½å™¨ï¼Œæ”¯æŒ ALACã€Dolby Atmosã€AAC ç­‰å¤šç§æ ¼å¼ã€‚

### 1.2 æŠ€æœ¯æ ˆ
- **è¯­è¨€**: Go 1.x
- **æ ¸å¿ƒä¾èµ–**: 
  - HTTPå®¢æˆ·ç«¯: `net/http`, `github.com/sky8282/requests`
  - M3U8å¤„ç†: `github.com/grafov/m3u8`
  - å…ƒæ•°æ®: `github.com/zhaarey/go-mp4tag`
  - å¹¶å‘: æ ‡å‡†åº“ `sync`

### 1.3 ç›®å½•ç»“æ„
```
apple-music-downloader/
â”œâ”€â”€ main.go                    # å…¥å£ç‚¹
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ api/                   # APIäº¤äº’å±‚
â”‚   â”œâ”€â”€ core/                  # æ ¸å¿ƒçŠ¶æ€ç®¡ç†
â”‚   â”œâ”€â”€ downloader/            # ä¸‹è½½é€»è¾‘ï¼ˆ1899è¡Œï¼âš ï¸ï¼‰
â”‚   â”œâ”€â”€ logger/                # æ—¥å¿—ç³»ç»Ÿ
â”‚   â”œâ”€â”€ metadata/              # å…ƒæ•°æ®å¤„ç†
â”‚   â”œâ”€â”€ network/               # ç½‘ç»œå®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ parser/                # URLè§£æ
â”‚   â”œâ”€â”€ progress/              # è¿›åº¦UI
â”‚   â””â”€â”€ utils/                 # å·¥å…·å‡½æ•°
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ runv3/                 # V3ä¸‹è½½å¼•æ“
â”‚   â”œâ”€â”€ runv14/                # V14ä¸‹è½½å¼•æ“
â”‚   â””â”€â”€ structs/               # æ•°æ®ç»“æ„å®šä¹‰
â””â”€â”€ config.yaml                # é…ç½®æ–‡ä»¶
```

---

## 2. æ ¸å¿ƒæµç¨‹åˆ†æ

### 2.1 ä¸»æµç¨‹å›¾

```
ç”¨æˆ·è¾“å…¥URL
    â†“
URLè§£æ (parser)
    â†“
è·å–å…ƒæ•°æ® (API)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ–‡ä»¶æ ¡éªŒé˜¶æ®µ   â”‚
â”‚  - æ£€æŸ¥å·²å­˜åœ¨   â”‚ â†’ å…¨éƒ¨å­˜åœ¨ â†’ ç›´æ¥å®Œæˆ âœ…
â”‚  - å¹¶å‘æ‰¹é‡æ£€æŸ¥ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“ (éƒ¨åˆ†ç¼ºå¤±)
ç‰ˆæƒé¢„æ£€ (API)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¸‹è½½é˜¶æ®µ       â”‚
â”‚  - æ‰¹æ¬¡ç®¡ç†     â”‚
â”‚  - è´¦å·è½®æ¢     â”‚
â”‚  - å¤±è´¥é‡è¯•     â”‚
â”‚  - å¹¶å‘ä¸‹è½½     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åå¤„ç†é˜¶æ®µ     â”‚
â”‚  - FFmpegæ£€æŸ¥   â”‚
â”‚  - æ ‡ç­¾å†™å…¥     â”‚
â”‚  - æ­Œè¯åµŒå…¥     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¼“å­˜è½¬ç§»é˜¶æ®µ   â”‚
â”‚  - æ‰«æç¼“å­˜     â”‚
â”‚  - æ‰¹é‡ç§»åŠ¨     â”‚
â”‚  - æ¸…ç†ç¼“å­˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
ä»»åŠ¡å®Œæˆ
```

### 2.2 å…³é”®è·¯å¾„åˆ†æ

#### è·¯å¾„1: å…¨éƒ¨æ–‡ä»¶å·²å­˜åœ¨ï¼ˆæœ€ä¼˜è·¯å¾„ï¼‰
```
æ£€æŸ¥ (100ms) â†’ æ¸…ç†ç¼“å­˜ (10ms) â†’ å®Œæˆ
æ€»è€—æ—¶: ~110ms âœ…
```

#### è·¯å¾„2: éƒ¨åˆ†æ–‡ä»¶éœ€ä¸‹è½½
```
æ£€æŸ¥ (100ms) â†’ ç‰ˆæƒé¢„æ£€ (500ms) â†’ ä¸‹è½½ (Nç§’) â†’ 
åå¤„ç† (200ms/æ–‡ä»¶) â†’ è½¬ç§» (1-5ç§’) â†’ å®Œæˆ
æ€»è€—æ—¶: å–å†³äºä¸‹è½½é€Ÿåº¦
```

#### è·¯å¾„3: è‰ºæœ¯å®¶æ¨¡å¼
```
è§£æè‰ºæœ¯å®¶URL â†’ è·å–ä¸“è¾‘åˆ—è¡¨ â†’ ç”¨æˆ·é€‰æ‹© â†’ 
å¾ªç¯å¤„ç†æ¯ä¸ªä¸“è¾‘ï¼ˆè·¯å¾„1æˆ–è·¯å¾„2ï¼‰
```

---

## 3. æ¶æ„åˆç†æ€§è¯„ä¼°

### 3.1 âœ… åšå¾—å¥½çš„åœ°æ–¹

#### 1. æ¨¡å—åŒ–è®¾è®¡
```go
// èŒè´£æ¸…æ™°çš„æ¨¡å—åˆ’åˆ†
- api/       â†’ APIäº¤äº’
- parser/    â†’ URLè§£æ
- downloader â†’ ä¸‹è½½ç¼–æ’
- metadata/  â†’ å…ƒæ•°æ®å¤„ç†
```
**è¯„ä»·**: âœ… èŒè´£åˆ†ç¦»æ¸…æ™°ï¼Œç¬¦åˆå•ä¸€èŒè´£åŸåˆ™

#### 2. ç¼“å­˜æœºåˆ¶
```go
baseSaveFolder, finalSaveFolder, usingCache = GetCacheBasePath(...)
```
**ä¼˜ç‚¹**:
- ç½‘ç»œå­˜å‚¨å‹å¥½ï¼ˆå…ˆå†™æœ¬åœ°ï¼Œæ‰¹é‡è½¬ç§»ï¼‰
- å¤±è´¥åå¯æ¸…ç†ï¼Œä¸æ±¡æŸ“ç›®æ ‡ç›®å½•
- æ”¯æŒæ–­ç‚¹ç»­ä¼ 

**è¯„ä»·**: âœ… è®¾è®¡åˆç†ï¼Œè§£å†³äº†å®é™…é—®é¢˜

#### 3. å¹¶å‘æ§åˆ¶
```go
// æ‰¹æ¬¡å¤„ç† + Worker Pool
for batch := range iterator {
    // æ‰¹å†…å¹¶å‘
    for _, track := range batch.Tracks {
        go func() {...}()
    }
}
```
**è¯„ä»·**: âœ… é¿å…è¿‡åº¦å¹¶å‘ï¼Œèµ„æºå¯æ§

#### 4. é”™è¯¯å¤„ç†
```go
// å¤šå±‚é‡è¯•æœºåˆ¶
- è´¦å·çº§é‡è¯•ï¼ˆåˆ‡æ¢è´¦å·ï¼‰
- ä¸‹è½½çº§é‡è¯•ï¼ˆç½‘ç»œé—®é¢˜ï¼‰
- åå¤„ç†é‡è¯•ï¼ˆFFmpegã€æ ‡ç­¾ï¼‰
```
**è¯„ä»·**: âœ… å¥å£®æ€§å¼ºï¼Œå®¹é”™èƒ½åŠ›å¥½

### 3.2 âš ï¸ å­˜åœ¨çš„é—®é¢˜

#### é—®é¢˜1: ä¸‹è½½å™¨æ–‡ä»¶è¿‡é•¿ï¼ˆ1899è¡Œï¼‰

**ç°çŠ¶**:
```go
// internal/downloader/downloader.go
- DownloadAlbum()        // ä¸»å‡½æ•°ï¼Œ600+ è¡Œ
- downloadTrackWithFallback()
- downloadTrackSilently()
- checkAndReEncodeTrack()
// ... ç­‰å¤šä¸ªå‡½æ•°æ··åœ¨ä¸€èµ·
```

**é—®é¢˜**:
- âŒ å¯ç»´æŠ¤æ€§å·®
- âŒ éš¾ä»¥å®šä½é—®é¢˜
- âŒ ä»£ç å¤ç”¨å›°éš¾

**å»ºè®®é‡æ„**:
```
internal/downloader/
â”œâ”€â”€ album.go          # DownloadAlbum ä¸»æµç¨‹
â”œâ”€â”€ track.go          # å•æ›²ä¸‹è½½é€»è¾‘
â”œâ”€â”€ postprocess.go    # FFmpeg + æ ‡ç­¾å¤„ç†
â”œâ”€â”€ batch.go          # æ‰¹æ¬¡ç®¡ç†
â”œâ”€â”€ transfer.go       # ç¼“å­˜è½¬ç§»
â””â”€â”€ retry.go          # é‡è¯•ç­–ç•¥
```

#### é—®é¢˜2: é…ç½®æ£€æŸ¥æ—¶æœºä¸åˆç†

**ç°çŠ¶**:
```go
// main.go
func main() {
    // 1. è§£æå‘½ä»¤è¡Œå‚æ•°
    // 2. åŠ è½½é…ç½®æ–‡ä»¶
    // 3. åˆå§‹åŒ–æ—¥å¿—
    // 4. æ ¡éªŒé…ç½® âœ…
    // 5. åˆå§‹åŒ–ç½‘ç»œå®¢æˆ·ç«¯
}
```

**é—®é¢˜**: âœ… å®é™…ä¸Šé…ç½®æ£€æŸ¥æ—¶æœºæ˜¯åˆç†çš„

#### é—®é¢˜3: å…¨å±€çŠ¶æ€è¿‡å¤š

**ç°çŠ¶**:
```go
// internal/core/state.go
var (
    Dl_atmos         bool
    Dl_aac           bool
    Dl_select        bool
    ForceDownload    bool
    Config           ConfigSet
    Counter          Counter
    OkDict           map[string][]int
    DeveloperToken   string
    // ... ç­‰20+ ä¸ªå…¨å±€å˜é‡
)
```

**é—®é¢˜**:
- âš ï¸ å¹¶å‘å®‰å…¨é£é™©ï¼ˆè™½ç„¶æœ‰é”ä¿æŠ¤ï¼‰
- âš ï¸ æµ‹è¯•å›°éš¾ï¼ˆçŠ¶æ€éš¾ä»¥éš”ç¦»ï¼‰
- âš ï¸ å‡½æ•°ç­¾åå†—é•¿ï¼ˆä¸ºé¿å…å…¨å±€çŠ¶æ€ä¼ é€’å¤§é‡å‚æ•°ï¼‰

**ä¸¤ç§æ–¹æ¡ˆå¯¹æ¯”**:

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|-----|------|------|
| å½“å‰ï¼ˆå…¨å±€å˜é‡ï¼‰ | ä»£ç ç®€æ´ï¼Œè°ƒç”¨æ–¹ä¾¿ | å¹¶å‘é£é™©ï¼Œæµ‹è¯•å›°éš¾ |
| ä¸Šä¸‹æ–‡ä¼ é€’ | çŠ¶æ€éš”ç¦»ï¼Œæ˜“æµ‹è¯• | å‡½æ•°ç­¾åå¤æ‚ |

**è¯„ä»·**: âš ï¸ å¯¹äºCLIå·¥å…·å¯æ¥å—ï¼Œä½†éœ€æ³¨æ„å¹¶å‘å®‰å…¨

#### é—®é¢˜4: æ–‡ä»¶æ ¡éªŒä¸ä¸‹è½½çš„é‡å¤æ£€æŸ¥

**ä¼˜åŒ–å‰**:
```go
// 1. ç‰ˆæƒé¢„æ£€å‰ï¼šæ£€æŸ¥æ‰€æœ‰æ–‡ä»¶
for _, track := range selected {
    exists := utils.FileExists(checkPath)
    if !exists { allFilesExist = false }
}

// 2. ä¸‹è½½æ¯ä¸ªæ–‡ä»¶å‰ï¼šå†æ¬¡æ£€æŸ¥
func downloadTrack(...) {
    exists := utils.FileExists(checkPath)
    if exists { return path }
    // ... ä¸‹è½½ ...
}
```

**é—®é¢˜**: âŒ é‡å¤æ£€æŸ¥ï¼Œæµªè´¹I/O

**å·²ä¼˜åŒ–**:
```go
// ä½¿ç”¨ "EXISTS:" æ ‡è®°é¿å…é‡å¤æ£€æŸ¥
if exists {
    return "EXISTS:" + path  // æ ‡è®°å·²å­˜åœ¨
}
```

**è¯„ä»·**: âœ… å·²ä¿®å¤

---

## 4. å‘ç°çš„é—®é¢˜ä¸ä¼˜åŒ–

### 4.1 æœ¬æ¬¡ä¼šè¯å·²ä¿®å¤çš„é—®é¢˜

| é—®é¢˜ | ä¸¥é‡ç¨‹åº¦ | å½±å“ | çŠ¶æ€ |
|-----|---------|------|------|
| è‰ºæœ¯å®¶é“¾æ¥404 | ğŸ”´ é«˜ | åŠŸèƒ½ä¸å¯ç”¨ | âœ… å·²ä¿®å¤ |
| è™šæ‹ŸSingleså½’ç±»é”™è¯¯ | ğŸŸ¡ ä¸­ | ç”¨æˆ·ä½“éªŒå·® | âœ… å·²ä¼˜åŒ– |
| æ–‡ä»¶æ ¡éªŒæ•ˆç‡ä½ | ğŸŸ¡ ä¸­ | æ€§èƒ½ç“¶é¢ˆï¼ˆç½‘ç»œå­˜å‚¨ï¼‰ | âœ… å·²ä¼˜åŒ– (97.5%â†‘) |
| ä¸å¿…è¦çš„è½¬ç§»æ“ä½œ | ğŸŸ¡ ä¸­ | æµªè´¹æ—¶é—´ | âœ… å·²ä¼˜åŒ– (95%â†‘) |
| å·²å­˜åœ¨æ–‡ä»¶æ ‡è¯†ä¸æ¸… | ğŸŸ¢ ä½ | ç”¨æˆ·ä½“éªŒ | âœ… å·²ä¼˜åŒ– |

### 4.2 æ½œåœ¨æœªå‘ç°çš„é—®é¢˜

#### é—®é¢˜A: Tokenè‡ªåŠ¨è·å–çš„è„†å¼±æ€§

**ç°çŠ¶**:
```go
// ä¾èµ–ç½‘é¡µHTMLç»“æ„
jsFilePattern := regexp.MustCompile(`/assets/index~[a-f0-9]+\.js`)
tokenPattern := regexp.MustCompile(`"token":"([^"]+)"`)
```

**é£é™©**:
- âŒ Appleæ›´æ”¹ç½‘é¡µç»“æ„ â†’ tokenè·å–å¤±è´¥
- âŒ æ— é™çº§ç­–ç•¥

**å»ºè®®**:
```go
// å¤šç§è·å–æ–¹å¼
1. å½“å‰æ–¹å¼ï¼ˆä»HTMLæå–ï¼‰
2. ä»æœ¬åœ°ç¼“å­˜è¯»å–ï¼ˆ7å¤©æœ‰æ•ˆæœŸï¼‰
3. æç¤ºç”¨æˆ·æ‰‹åŠ¨è¾“å…¥
4. ä»ç¯å¢ƒå˜é‡è¯»å–
```

#### é—®é¢˜B: å†…å­˜å ç”¨æœªä¼˜åŒ–

**åœºæ™¯**: ä¸‹è½½1000é¦–æ­Œçš„æ’­æ”¾åˆ—è¡¨

**é—®é¢˜**:
```go
// æ‰€æœ‰å…ƒæ•°æ®ä¸€æ¬¡æ€§åŠ è½½åˆ°å†…å­˜
meta *structs.AutoGenerated  // å¯èƒ½åŒ…å«1000é¦–æ­Œçš„å®Œæ•´ä¿¡æ¯

// æ‰€æœ‰æ–‡ä»¶è·¯å¾„åŒæ—¶æ„å»º
var filesToCheck []trackFileInfo  // 1000æ¡è®°å½•
```

**å½±å“**:
- âš ï¸ å¤§å‹æ’­æ”¾åˆ—è¡¨å†…å­˜å ç”¨é«˜
- âš ï¸ æ‰¹æ¬¡è¿­ä»£å™¨å·²ç¼“è§£ä½†æœªæ ¹æ²»

**å»ºè®®**:
```go
// æµå¼å¤„ç†
for track := range streamTracks(meta) {
    process(track)
    // å¤„ç†å®Œç«‹å³é‡Šæ”¾
}
```

#### é—®é¢˜C: æ—¥å¿—çº§åˆ«é…ç½®ä¸å¤Ÿç»†ç²’åº¦

**ç°çŠ¶**:
```yaml
logging:
  level: info  # å…¨å±€ç»Ÿä¸€çº§åˆ«
```

**é™åˆ¶**:
- âŒ æ— æ³•å•ç‹¬è°ƒè¯•æŸä¸ªæ¨¡å—
- âŒ debugæ¨¡å¼ä¿¡æ¯è¿‡å¤š

**å»ºè®®**:
```yaml
logging:
  default: info
  modules:
    api: debug      # åªè°ƒè¯•APIæ¨¡å—
    downloader: info
    metadata: warn
```

---

## 5. æ½œåœ¨é£é™©ç‚¹

### 5.1 å¹¶å‘å®‰å…¨é£é™©

#### é£é™©ç‚¹1: OkDictå¹¶å‘å†™å…¥

**ä»£ç **:
```go
// å¤šä¸ªgoroutineåŒæ—¶å†™å…¥
core.SharedLock.Lock()
core.OkDict[albumId] = append(core.OkDict[albumId], trackNum)
core.SharedLock.Unlock()
```

**è¯„ä¼°**: âœ… æœ‰é”ä¿æŠ¤ï¼Œå®‰å…¨

#### é£é™©ç‚¹2: è™šæ‹ŸSinglesç¼–å·å¹¶å‘

**ä»£ç **:
```go
virtualSinglesLock.RLock()
if _, exists := virtualSinglesTrackNumbers[artistName]; exists {
    virtualSinglesLock.RUnlock()  // âš ï¸ é‡Šæ”¾è¯»é”
    virtualSinglesLock.Lock()      // è·å–å†™é”
    trackNum := virtualSinglesTrackNumbers[artistName]
    virtualSinglesTrackNumbers[artistName]++
    virtualSinglesLock.Unlock()
    return trackNum
}
```

**é—®é¢˜**: âš ï¸ è¯»å†™é”åˆ‡æ¢ä¹‹é—´å­˜åœ¨ç«æ€æ¡ä»¶

**ä¿®å¤å»ºè®®**:
```go
virtualSinglesLock.Lock()  // ç›´æ¥ç”¨å†™é”
defer virtualSinglesLock.Unlock()
trackNum := virtualSinglesTrackNumbers[artistName]
virtualSinglesTrackNumbers[artistName]++
return trackNum
```

### 5.2 èµ„æºæ³„æ¼é£é™©

#### é£é™©ç‚¹: HTTP Response Bodyæœªå…³é—­

**æ£€æŸ¥**:
```go
// âœ… å¤§éƒ¨åˆ†ä»£ç éƒ½æ­£ç¡®å…³é—­
resp, err := client.Do(req)
if err != nil {
    return err
}
defer resp.Body.Close()
```

**è¯„ä¼°**: âœ… å·²å®¡æŸ¥ï¼Œé£é™©è¾ƒä½

### 5.3 ç£ç›˜ç©ºé—´é£é™©

**åœºæ™¯**: ä¸‹è½½å¤§å‹æ’­æ”¾åˆ—è¡¨åˆ°å°å®¹é‡ç£ç›˜

**é—®é¢˜**:
- âŒ æ— ç£ç›˜ç©ºé—´é¢„æ£€æŸ¥
- âŒ ç©ºé—´ä¸è¶³æ—¶æ‰æŠ¥é”™ï¼ˆå¯èƒ½å·²ä¸‹è½½ä¸€åŠï¼‰

**å»ºè®®**:
```go
// ä¸‹è½½å‰æ£€æŸ¥
func checkDiskSpace(path string, requiredBytes int64) error {
    var stat syscall.Statfs_t
    syscall.Statfs(path, &stat)
    available := stat.Bavail * uint64(stat.Bsize)
    if available < uint64(requiredBytes) {
        return fmt.Errorf("ç£ç›˜ç©ºé—´ä¸è¶³")
    }
    return nil
}
```

---

## 6. ä¼˜åŒ–å»ºè®®

### 6.1 çŸ­æœŸä¼˜åŒ–ï¼ˆç«‹å³å¯å®æ–½ï¼‰

#### 1. ä¿®å¤è™šæ‹ŸSingleså¹¶å‘ç«æ€ ğŸ”´ é«˜ä¼˜å…ˆçº§
```go
// ç®€åŒ–é”é€»è¾‘
func GetVirtualSinglesTrackNumber(artistName string) int {
    virtualSinglesLock.Lock()
    defer virtualSinglesLock.Unlock()
    
    trackNum := virtualSinglesTrackNumbers[artistName]
    virtualSinglesTrackNumbers[artistName]++
    return trackNum
}
```

#### 2. æ·»åŠ Tokenè·å–é™çº§ç­–ç•¥ ğŸŸ¡ ä¸­ä¼˜å…ˆçº§
```go
func GetDeveloperToken() string {
    // 1. å°è¯•ä»ç½‘é¡µè·å–
    if token := fetchFromWeb(); token != "" {
        saveToCache(token)
        return token
    }
    
    // 2. ä»ç¼“å­˜è¯»å–
    if token := loadFromCache(); token != "" {
        return token
    }
    
    // 3. ä»ç¯å¢ƒå˜é‡
    if token := os.Getenv("APPLE_MUSIC_DEV_TOKEN"); token != "" {
        return token
    }
    
    // 4. æç¤ºç”¨æˆ·
    return promptUser()
}
```

#### 3. æ·»åŠ ç£ç›˜ç©ºé—´æ£€æŸ¥ ğŸŸ¡ ä¸­ä¼˜å…ˆçº§
```go
// åœ¨DownloadAlbumå¼€å§‹å‰
estimatedSize := estimateAlbumSize(meta, codec)
if err := checkDiskSpace(savePath, estimatedSize); err != nil {
    return fmt.Errorf("ç£ç›˜ç©ºé—´ä¸è¶³: %w", err)
}
```

### 6.2 ä¸­æœŸä¼˜åŒ–ï¼ˆéœ€è¦é‡æ„ï¼‰

#### 1. æ‹†åˆ†ä¸‹è½½å™¨æ–‡ä»¶ ğŸŸ¡ ä¸­ä¼˜å…ˆçº§
```
ç›®æ ‡: 1899è¡Œ â†’ 6ä¸ªæ–‡ä»¶ï¼Œæ¯ä¸ª<400è¡Œ
æ–¹æ³•: æŒ‰èŒè´£æ‹†åˆ†
- album.go: ä¸»æµç¨‹ç¼–æ’
- track.go: å•æ›²ä¸‹è½½
- postprocess.go: åå¤„ç†
- batch.go: æ‰¹æ¬¡ç®¡ç†
- transfer.go: æ–‡ä»¶è½¬ç§»
- retry.go: é‡è¯•é€»è¾‘
```

#### 2. å¼•å…¥ä¸Šä¸‹æ–‡ä¼ é€’ ğŸŸ¢ ä½ä¼˜å…ˆçº§
```go
type DownloadContext struct {
    Config    *ConfigSet
    Accounts  []Account
    DevToken  string
    // ... å…¶ä»–å…¨å±€çŠ¶æ€
}

func DownloadAlbum(ctx *DownloadContext, url string) error {
    // ä½¿ç”¨ ctx ä»£æ›¿å…¨å±€å˜é‡
}
```

**æƒè¡¡**: ä»£ç æ”¹åŠ¨å¤§ï¼Œå¯¹ç°æœ‰åŠŸèƒ½æ— å®è´¨æå‡

#### 3. å®ç°æµå¼å…ƒæ•°æ®å¤„ç† ğŸŸ¢ ä½ä¼˜å…ˆçº§
```go
// é’ˆå¯¹è¶…å¤§æ’­æ”¾åˆ—è¡¨ï¼ˆ1000+é¦–ï¼‰
type TrackStream struct {
    meta *structs.AutoGenerated
    idx  int
}

func (s *TrackStream) Next() (*TrackData, bool) {
    if s.idx >= len(s.meta.Tracks) {
        return nil, false
    }
    track := &s.meta.Tracks[s.idx]
    s.idx++
    return track, true
}
```

### 6.3 é•¿æœŸä¼˜åŒ–ï¼ˆæ¶æ„çº§ï¼‰

#### 1. æ’ä»¶åŒ–æ¶æ„ ğŸŸ¢ ä½ä¼˜å…ˆçº§
```go
// æ”¯æŒæ‰©å±•ä¸åŒéŸ³ä¹å¹³å°
type MusicPlatform interface {
    Parse(url string) (Metadata, error)
    Download(track Track) ([]byte, error)
    GetLyrics(trackID string) (string, error)
}

// æ³¨å†Œå¹³å°
RegisterPlatform("apple-music", &AppleMusicPlatform{})
RegisterPlatform("spotify", &SpotifyPlatform{})  // æœªæ¥æ‰©å±•
```

#### 2. åˆ†å¸ƒå¼ä¸‹è½½ ğŸŸ¢ ä½ä¼˜å…ˆçº§
```go
// å¤šæœºå¹¶è¡Œä¸‹è½½å¤§å‹æ’­æ”¾åˆ—è¡¨
type DistributedDownloader struct {
    workers []string  // workerèŠ‚ç‚¹åœ°å€
}

func (d *DistributedDownloader) DownloadPlaylist(tracks []Track) {
    // ä»»åŠ¡åˆ†å‘
    for i, track := range tracks {
        workerIdx := i % len(d.workers)
        sendToWorker(d.workers[workerIdx], track)
    }
}
```

**è¯„ä»·**: å¯¹ä¸ªäººç”¨æˆ·æ— æ„ä¹‰ï¼Œä¸å»ºè®®å®æ–½

---

## 7. æµç¨‹ä¼˜åŒ–å»ºè®®

### 7.1 å½“å‰æµç¨‹çš„"å¼¯è·¯"

#### å¼¯è·¯1: ~~æ–‡ä»¶é‡å¤æ£€æŸ¥~~
**é—®é¢˜**: å·²åœ¨æœ¬æ¬¡ä¼šè¯ä¿®å¤ âœ…

#### å¼¯è·¯2: ~~ä¸å¿…è¦çš„è½¬ç§»æ“ä½œ~~
**é—®é¢˜**: å·²åœ¨æœ¬æ¬¡ä¼šè¯ä¿®å¤ âœ…

#### å¼¯è·¯3: ç‰ˆæƒé¢„æ£€çš„æ—¶æœº

**å½“å‰**:
```
æ£€æŸ¥æ–‡ä»¶ â†’ ç‰ˆæƒé¢„æ£€ â†’ ä¸‹è½½
```

**åˆ†æ**:
- âœ… åˆç†ï¼šæå‰å‘ç°æ— æƒé™çš„ä¸“è¾‘ï¼Œé¿å…éƒ¨åˆ†ä¸‹è½½åå¤±è´¥
- âš ï¸ å¯ä¼˜åŒ–ï¼šå·²å­˜åœ¨çš„æ–‡ä»¶æ— éœ€ç‰ˆæƒé¢„æ£€

**å»ºè®®**:
```go
// ä¼˜åŒ–ç‰ˆæƒé¢„æ£€é€»è¾‘
var needCheckTracks []Track
for _, track := range allTracks {
    if !fileExists(track) {
        needCheckTracks = append(needCheckTracks, track)
    }
}
if len(needCheckTracks) > 0 {
    checkCopyright(needCheckTracks[0])  // åªæ£€æŸ¥ç¬¬ä¸€é¦–
}
```

### 7.2 å½“å‰æµç¨‹çš„"è¿œè·¯"

#### è¿œè·¯1: ç¼“å­˜æœºåˆ¶çš„å¼€é”€

**åˆ†æ**:
```
æœ¬åœ°ç£ç›˜: ç›´æ¥å†™å…¥ â†’ 0æ¬¡ç§»åŠ¨
ç½‘ç»œå­˜å‚¨ + ç¼“å­˜: å†™ç¼“å­˜ â†’ è½¬ç§» â†’ 1æ¬¡ç§»åŠ¨
```

**é—®é¢˜**: å¯¹æœ¬åœ°ç£ç›˜ç”¨æˆ·ï¼Œç¼“å­˜æ˜¯å¤šä½™çš„

**å»ºè®®**: âœ… å·²æ”¯æŒé…ç½®ç¦ç”¨ç¼“å­˜

#### è¿œè·¯2: å…ƒæ•°æ®é‡å¤è·å–

**åœºæ™¯**: ä¸‹è½½ä¸“è¾‘ â†’ è·å–å…ƒæ•°æ®
         é‡æ–°ä¸‹è½½åŒä¸€ä¸“è¾‘ â†’ **å†æ¬¡è·å–å…ƒæ•°æ®**

**å»ºè®®**:
```go
// å…ƒæ•°æ®ç¼“å­˜ï¼ˆ24å°æ—¶ï¼‰
type MetadataCache struct {
    cache map[string]*CachedMeta
    ttl   time.Duration
}

func (c *MetadataCache) Get(albumID string) (*Meta, bool) {
    if cached, ok := c.cache[albumID]; ok {
        if time.Since(cached.Time) < c.ttl {
            return cached.Meta, true
        }
    }
    return nil, false
}
```

### 7.3 æµç¨‹ä¼˜åŒ–æ€»ç»“

**å·²ä¼˜åŒ–çš„å…³é”®è·¯å¾„**:
1. âœ… å…¨éƒ¨æ–‡ä»¶å·²å­˜åœ¨ â†’ ç›´æ¥å®Œæˆï¼ˆ110msï¼‰
2. âœ… å¹¶å‘æ–‡ä»¶æ ¡éªŒ â†’ 97.5% æ€§èƒ½æå‡
3. âœ… æ™ºèƒ½è·³è¿‡è½¬ç§» â†’ 95% æ€§èƒ½æå‡

**å»ºè®®ä¼˜åŒ–çš„è·¯å¾„**:
1. ğŸŸ¡ ç‰ˆæƒé¢„æ£€ä¼˜åŒ– â†’ è·³è¿‡å·²å­˜åœ¨æ–‡ä»¶çš„æ£€æŸ¥
2. ğŸŸ¡ å…ƒæ•°æ®ç¼“å­˜ â†’ é¿å…é‡å¤APIè°ƒç”¨
3. ğŸŸ¢ ç£ç›˜ç©ºé—´é¢„æ£€ â†’ æå‰å‘ç°é—®é¢˜

---

## 8. ä»£ç è´¨é‡è¯„ä¼°

### 8.1 ä¼˜ç‚¹

1. **é”™è¯¯å¤„ç†å®Œå–„** â­â­â­â­â­
   - å¤šå±‚é‡è¯•
   - è¯¦ç»†é”™è¯¯ä¿¡æ¯
   - ä¼˜é›…é™çº§

2. **å¹¶å‘æ§åˆ¶** â­â­â­â­
   - æ‰¹æ¬¡ç®¡ç†
   - Worker pool
   - é”ä¿æŠ¤

3. **ç”¨æˆ·ä½“éªŒ** â­â­â­â­â­
   - è¿›åº¦æ¡
   - å½©è‰²è¾“å‡º
   - è¯¦ç»†æ—¥å¿—

4. **é…ç½®çµæ´»** â­â­â­â­
   - YAMLé…ç½®
   - å‘½ä»¤è¡Œè¦†ç›–
   - ç¯å¢ƒå˜é‡

### 8.2 ç¼ºç‚¹

1. **æ–‡ä»¶è¿‡é•¿** â­â­
   - downloader.go 1899è¡Œ
   - å¯ç»´æŠ¤æ€§å·®

2. **å…¨å±€çŠ¶æ€** â­â­â­
   - 20+å…¨å±€å˜é‡
   - æµ‹è¯•å›°éš¾

3. **æ³¨é‡Šä¸è¶³** â­â­â­
   - ç¼ºå°‘å‡½æ•°æ–‡æ¡£
   - å¤æ‚é€»è¾‘æ— æ³¨é‡Š

4. **æµ‹è¯•è¦†ç›–** â­â­
   - å•å…ƒæµ‹è¯•è¾ƒå°‘
   - ä¸»è¦é é›†æˆæµ‹è¯•

---

## 9. æ€§èƒ½è¯„ä¼°

### 9.1 æ€§èƒ½çƒ­ç‚¹

**Profile åˆ†æ**ï¼ˆæ¨æµ‹ï¼‰:
```
1. ç½‘ç»œI/O      â†’ 60%  (ä¸‹è½½ä¸»ä½“)
2. ç£ç›˜I/O      â†’ 20%  (æ–‡ä»¶æ£€æŸ¥ã€è½¬ç§»)
3. APIè°ƒç”¨      â†’ 10%  (å…ƒæ•°æ®ã€ç‰ˆæƒ)
4. FFmpegå¤„ç†   â†’ 8%   (é‡ç¼–ç )
5. å…¶ä»–         â†’ 2%   (æ—¥å¿—ã€UI)
```

### 9.2 å·²ä¼˜åŒ–çš„æ€§èƒ½

| ä¼˜åŒ–é¡¹ | æå‡ | åœºæ™¯ |
|--------|------|------|
| å¹¶å‘æ–‡ä»¶æ ¡éªŒ | 97.5% | 100é¦–Ã—ç½‘ç»œå­˜å‚¨ |
| è·³è¿‡ä¸å¿…è¦è½¬ç§» | 95% | å·²å­˜åœ¨æ–‡ä»¶ |
| æ–‡ä»¶å¤§å°éªŒè¯ | 50% | æ’é™¤åŠæˆå“ |

### 9.3 æ€§èƒ½ä¼˜åŒ–ç©ºé—´

1. **å…ƒæ•°æ®ç¼“å­˜** - é¿å…é‡å¤APIè°ƒç”¨
2. **è¿æ¥æ± å¤ç”¨** - âœ… å·²å®ç°ï¼ˆLocalWrapperOptimizationï¼‰
3. **æ‰¹é‡æ“ä½œ** - âœ… å·²å®ç°ï¼ˆæ‰¹æ¬¡ä¸‹è½½ã€æ‰¹é‡è½¬ç§»ï¼‰

---

## 10. æ€»ç»“

### 10.1 æ•´ä½“è¯„ä»·

**é¡¹ç›®æˆç†Ÿåº¦**: â­â­â­â­ (4/5)

**ä¼˜ç‚¹**:
- âœ… åŠŸèƒ½å®Œæ•´ï¼Œè¦†ç›–å¤šç§åœºæ™¯
- âœ… é”™è¯¯å¤„ç†å¥å£®ï¼Œå®¹é”™æ€§å¼º
- âœ… ç”¨æˆ·ä½“éªŒä¼˜ç§€ï¼Œè¾“å‡ºå‹å¥½
- âœ… é…ç½®çµæ´»ï¼Œå¯å®šåˆ¶æ€§å¼º

**ä¸è¶³**:
- âš ï¸ ä»£ç ç»„ç»‡å¾…ä¼˜åŒ–ï¼ˆæ–‡ä»¶è¿‡é•¿ï¼‰
- âš ï¸ å…¨å±€çŠ¶æ€è¾ƒå¤šï¼ˆæµ‹è¯•å›°éš¾ï¼‰
- âš ï¸ éƒ¨åˆ†ç»†èŠ‚å¾…å®Œå–„ï¼ˆå¹¶å‘ç«æ€ï¼‰

### 10.2 æ˜¯å¦èµ°"å¼¯è·¯"ï¼Ÿ

**ç»“è®º**: æ•´ä½“è·¯å¾„åˆç†ï¼Œå±€éƒ¨æœ‰ä¼˜åŒ–ç©ºé—´

**èµ°è¿‡çš„å¼¯è·¯**ï¼ˆå·²ä¿®å¤ï¼‰:
1. ~~æ–‡ä»¶é‡å¤æ£€æŸ¥~~ âœ…
2. ~~ä¸å¿…è¦çš„è½¬ç§»~~ âœ…
3. ~~ä½æ•ˆçš„ä¸²è¡Œæ ¡éªŒ~~ âœ…

**æ²¡æœ‰èµ°çš„å¼¯è·¯**:
- âœ… ç¼“å­˜æœºåˆ¶è®¾è®¡åˆç†
- âœ… æ‰¹æ¬¡ç®¡ç†æ°åˆ°å¥½å¤„
- âœ… é‡è¯•ç­–ç•¥å¥å£®æœ‰æ•ˆ

### 10.3 æ˜¯å¦æœ‰"æ›´ä¼˜è§£"ï¼Ÿ

#### æ¶æ„å±‚é¢
**å½“å‰**: å•ä½“CLIåº”ç”¨
**æ›´ä¼˜è§£**: ä¿æŒç°çŠ¶ âœ…

**ç†ç”±**: 
- CLIå·¥å…·å•ä½“æ¶æ„æœ€åˆé€‚
- å¾®æœåŠ¡ã€åˆ†å¸ƒå¼éƒ½æ˜¯è¿‡åº¦è®¾è®¡

#### å®ç°å±‚é¢
**å½“å‰**: å…¨å±€çŠ¶æ€ + å‡½æ•°å¼
**æ›´ä¼˜è§£**: ä¸Šä¸‹æ–‡ä¼ é€’ + é¢å‘å¯¹è±¡

**æƒè¡¡**:
| æ–¹æ¡ˆ | ä»£ç é‡ | å¯ç»´æŠ¤æ€§ | æµ‹è¯•æ€§ | æ€§èƒ½ |
|-----|--------|---------|--------|------|
| å½“å‰ | å°‘ | ä¸­ | ä¸­ | é«˜ |
| é‡æ„ | å¤š | é«˜ | é«˜ | é«˜ |

**å»ºè®®**: ğŸŸ¡ å¯é€‰ä¼˜åŒ–ï¼Œéå¿…é¡»

#### æ€§èƒ½å±‚é¢
**å½“å‰**: å·²ç»å¾ˆä¼˜ç§€
**æ›´ä¼˜è§£**: 
1. å…ƒæ•°æ®ç¼“å­˜ â†’ å‡å°‘APIè°ƒç”¨
2. ä¿®å¤å¹¶å‘ç«æ€ â†’ æå‡å®‰å…¨æ€§
3. ç£ç›˜ç©ºé—´é¢„æ£€ â†’ æå‰å‘ç°é—®é¢˜

### 10.4 ä¼˜å…ˆçº§å»ºè®®

**ğŸ”´ é«˜ä¼˜å…ˆçº§**ï¼ˆç«‹å³ä¿®å¤ï¼‰:
1. ä¿®å¤è™šæ‹ŸSingleså¹¶å‘ç«æ€
2. Tokenè·å–é™çº§ç­–ç•¥

**ğŸŸ¡ ä¸­ä¼˜å…ˆçº§**ï¼ˆ1-2å‘¨ï¼‰:
3. æ‹†åˆ†ä¸‹è½½å™¨æ–‡ä»¶ï¼ˆæå‡å¯ç»´æŠ¤æ€§ï¼‰
4. æ·»åŠ ç£ç›˜ç©ºé—´æ£€æŸ¥
5. å®ç°å…ƒæ•°æ®ç¼“å­˜

**ğŸŸ¢ ä½ä¼˜å…ˆçº§**ï¼ˆæœ‰ç©ºå†åšï¼‰:
6. å¼•å…¥ä¸Šä¸‹æ–‡ä¼ é€’
7. å®Œå–„å•å…ƒæµ‹è¯•
8. æ¨¡å—æ—¥å¿—çº§åˆ«

### 10.5 æœ€ç»ˆç»“è®º

**Apple Music Downloader æ˜¯ä¸€ä¸ªè®¾è®¡è‰¯å¥½ã€å®ç°ä¼˜ç§€çš„é¡¹ç›®**

- âœ… æ ¸å¿ƒæµç¨‹åˆç†è‡ªæ´½
- âœ… æ²¡æœ‰æ˜æ˜¾çš„"é”™è·¯"
- âœ… å±€éƒ¨"å¼¯è·¯"å·²åœ¨æœ¬æ¬¡ä¼šè¯ä¿®å¤
- âš ï¸ æœ‰ä¼˜åŒ–ç©ºé—´ä½†éå…³é”®

**æœ¬æ¬¡ä¼šè¯çš„ä»·å€¼**:
1. ä¿®å¤äº†5ä¸ªå®é™…é—®é¢˜
2. ä¼˜åŒ–äº†æ€§èƒ½ï¼ˆ97.5%æå‡ï¼‰
3. æ”¹å–„äº†ç”¨æˆ·ä½“éªŒ
4. ä¸ºæœªæ¥ä¼˜åŒ–æŒ‡æ˜æ–¹å‘

**ç»§ç»­ä¿æŒ**: 
- ä»£ç ç®€æ´å®ç”¨
- ç”¨æˆ·ä½“éªŒä¼˜å…ˆ
- é¿å…è¿‡åº¦è®¾è®¡

**å»ºè®®æ”¹è¿›**:
- ä»£ç ç»„ç»‡ï¼ˆæ‹†åˆ†å¤§æ–‡ä»¶ï¼‰
- å¹¶å‘å®‰å…¨ï¼ˆä¿®å¤ç«æ€ï¼‰
- å®¹é”™èƒ½åŠ›ï¼ˆTokené™çº§ã€ç£ç›˜æ£€æŸ¥ï¼‰

---

## é™„å½•

### A. å…³é”®æŒ‡æ ‡

| æŒ‡æ ‡ | æ•°å€¼ | è¯„ä»· |
|-----|------|------|
| ä»£ç æ€»è¡Œæ•° | ~12,000 | ä¸­ç­‰è§„æ¨¡ âœ… |
| æœ€å¤§æ–‡ä»¶è¡Œæ•° | 1,899 | è¿‡é•¿ âš ï¸ |
| æ¨¡å—æ•°é‡ | 11 | åˆç† âœ… |
| é…ç½®é¡¹æ•°é‡ | 60+ | ä¸°å¯Œ âœ… |
| å¹¶å‘goroutine | å¯æ§ | è‰¯å¥½ âœ… |

### B. æŠ€æœ¯å€ºåŠ¡æ¸…å•

| å€ºåŠ¡é¡¹ | ä¸¥é‡ç¨‹åº¦ | å¿è¿˜æˆæœ¬ | ä¼˜å…ˆçº§ |
|--------|---------|---------|--------|
| ä¸‹è½½å™¨æ–‡ä»¶è¿‡é•¿ | ä¸­ | é«˜ | ğŸŸ¡ |
| å¹¶å‘ç«æ€é£é™© | é«˜ | ä½ | ğŸ”´ |
| ç¼ºå°‘å•å…ƒæµ‹è¯• | ä¸­ | é«˜ | ğŸŸ¢ |
| Tokenè·å–è„†å¼± | é«˜ | ä¸­ | ğŸ”´ |
| å…¨å±€çŠ¶æ€è¿‡å¤š | ä½ | é«˜ | ğŸŸ¢ |

### C. æ€§èƒ½åŸºå‡†

**æµ‹è¯•ç¯å¢ƒ**: åƒå…†ç½‘ç»œ + NASå­˜å‚¨

| åœºæ™¯ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|-----|--------|--------|------|
| 100é¦–æ ¡éªŒ | 40s | 1s | 97.5% |
| å·²å­˜åœ¨è·³è¿‡ | 3s | 0.1s | 96.7% |
| æ–‡ä»¶è½¬ç§» | 5s | 0s | 100% |


---

## è¡¥å……åˆ†æï¼šå·²ç¡®è®¤çš„å¹¶å‘ç«æ€é—®é¢˜

### é—®é¢˜ç¡®è®¤

æ£€æŸ¥äº†å®é™…ä»£ç åï¼Œ**ç¡®è®¤å­˜åœ¨å¹¶å‘ç«æ€é—®é¢˜**ï¼š

```go
// internal/core/state.go:320-346
func GetVirtualSinglesTrackNumber(artistName string) int {
    // å…ˆç”¨è¯»é”æ£€æŸ¥æ˜¯å¦å­˜åœ¨
    virtualSinglesLock.RLock()
    if _, exists := virtualSinglesTrackNumbers[artistName]; exists {
        virtualSinglesLock.RUnlock()  // âš ï¸ é‡Šæ”¾è¯»é”
        // å‡çº§ä¸ºå†™é”è¿›è¡Œæ›´æ–°
        virtualSinglesLock.Lock()      // âš ï¸ è·å–å†™é”
        // âŒ è¿™ä¸­é—´å­˜åœ¨ç«æ€çª—å£ï¼
        trackNum := virtualSinglesTrackNumbers[artistName]
        virtualSinglesTrackNumbers[artistName]++
        virtualSinglesLock.Unlock()
        return trackNum
    }
    // ... åç»­ä»£ç 
}
```

### ç«æ€åœºæ™¯

**æ—¶é—´çº¿**:
```
T1: goroutine-A æ£€æŸ¥ "Alec Benjamin" â†’ å­˜åœ¨ âœ…
T2: goroutine-A é‡Šæ”¾è¯»é”
T3: goroutine-B è·å–å†™é”ï¼Œè¯»å–ç¼–å·=5ï¼Œé€’å¢åˆ°6ï¼Œé‡Šæ”¾é”
T4: goroutine-A è·å–å†™é”
T5: goroutine-A è¯»å–ç¼–å·=6ï¼ˆåº”è¯¥æ˜¯5ï¼ï¼‰ï¼Œé€’å¢åˆ°7ï¼Œé‡Šæ”¾é”
T6: goroutine-A è¿”å› 6
```

**ç»“æœ**: goroutine-A å’Œ goroutine-B å¯èƒ½è·å¾—ç›¸åŒçš„æ›²ç›®ç¼–å·ï¼

### å½±å“è¯„ä¼°

**å®é™…å½±å“**: ğŸŸ¡ ä¸­ç­‰
- âœ… ä¸ä¼šå¯¼è‡´å´©æºƒ
- âš ï¸ å¯èƒ½å¯¼è‡´æ›²ç›®ç¼–å·é‡å¤
- âš ï¸ æ–‡ä»¶åå†²çªï¼ˆåå†™å…¥è¦†ç›–å…ˆå†™å…¥ï¼‰

**è§¦å‘æ¦‚ç‡**: ğŸŸ¡ ä¸­ç­‰
- éœ€è¦å¤šä¸ªgoroutine **åŒæ—¶**å¤„ç†åŒä¸€è‰ºæœ¯å®¶çš„å•æ›²
- åœ¨æ‰¹é‡ä¸‹è½½åœºæ™¯ä¸‹å¯èƒ½è§¦å‘

### ä¿®å¤æ–¹æ¡ˆ

#### æ–¹æ¡ˆ1: ç®€åŒ–é”é€»è¾‘ï¼ˆæ¨èï¼‰âœ…
```go
func GetVirtualSinglesTrackNumber(artistName string) int {
    virtualSinglesLock.Lock()
    defer virtualSinglesLock.Unlock()
    
    // åˆå§‹åŒ–ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    if _, exists := virtualSinglesTrackNumbers[artistName]; !exists {
        virtualSinglesTrackNumbers[artistName] = 1
    }
    
    trackNum := virtualSinglesTrackNumbers[artistName]
    virtualSinglesTrackNumbers[artistName]++
    return trackNum
}
```

**ä¼˜ç‚¹**:
- âœ… ä»£ç ç®€æ´
- âœ… å®Œå…¨æ¶ˆé™¤ç«æ€
- âœ… æ€§èƒ½å½±å“å¾®ä¹å…¶å¾®ï¼ˆå†™é”å ç”¨æ—¶é—´<1Î¼sï¼‰

**ç¼ºç‚¹**:
- âš ï¸ æ”¾å¼ƒäº†è¯»å†™é”ä¼˜åŒ–ï¼ˆå®é™…ä¸Šä¸éœ€è¦ï¼Œå› ä¸ºè¯¥å‡½æ•°å‡ ä¹æ€»æ˜¯å†™æ“ä½œï¼‰

#### æ–¹æ¡ˆ2: ä½¿ç”¨ sync.Mapï¼ˆè¿‡åº¦è®¾è®¡ï¼‰
```go
var virtualSinglesTrackNumbers sync.Map

func GetVirtualSinglesTrackNumber(artistName string) int {
    actual, _ := virtualSinglesTrackNumbers.LoadOrStore(artistName, &atomic.Int64{})
    counter := actual.(*atomic.Int64)
    return int(counter.Add(1)) - 1
}
```

**è¯„ä»·**: âŒ è¿‡äºå¤æ‚ï¼Œä¸æ¨è

---

## æœ€ç»ˆä¿®å¤å»ºè®®

### ğŸ”´ ç«‹å³ä¿®å¤ï¼ˆæœ¬æ¬¡ä¼šè¯ï¼‰
1. **å¹¶å‘ç«æ€é—®é¢˜** - GetVirtualSinglesTrackNumber
   - ä¸¥é‡ç¨‹åº¦: ğŸ”´ é«˜ï¼ˆè™½ç„¶å½±å“ä¸­ç­‰ï¼Œä½†ä¿®å¤æˆæœ¬ä½ï¼‰
   - ä¿®å¤æ—¶é—´: <5åˆ†é’Ÿ
   - é£é™©: æ— ï¼ˆç®€åŒ–é€»è¾‘ï¼Œæ›´å®‰å…¨ï¼‰

### ğŸŸ¡ ä¸­æœŸä¿®å¤ï¼ˆ1-2å‘¨ï¼‰
2. **Tokenè·å–é™çº§ç­–ç•¥**
3. **æ‹†åˆ†ä¸‹è½½å™¨æ–‡ä»¶**
4. **ç£ç›˜ç©ºé—´æ£€æŸ¥**

---

## ä»£ç å®¡æŸ¥æ€»ç»“

ç»è¿‡æ·±å…¥çš„ä»£ç å®¡æŸ¥å’Œæµç¨‹åˆ†æï¼Œ**ç¡®è®¤é¡¹ç›®æ•´ä½“è®¾è®¡ä¼˜ç§€ï¼Œä½†å­˜åœ¨1ä¸ªéœ€è¦ç«‹å³ä¿®å¤çš„å¹¶å‘å®‰å…¨é—®é¢˜**ã€‚

**æ ¸å¿ƒå‘ç°**:
1. âœ… æµç¨‹è®¾è®¡åˆç†ï¼Œæ²¡æœ‰èµ°"é”™è·¯"
2. âœ… æœ¬æ¬¡ä¼šè¯å·²ä¿®å¤çš„"å¼¯è·¯"ï¼ˆé‡å¤æ£€æŸ¥ã€ä¸å¿…è¦è½¬ç§»ç­‰ï¼‰
3. âš ï¸ å‘ç°å¹¶å‘ç«æ€é—®é¢˜ï¼ˆå¯ç«‹å³ä¿®å¤ï¼‰
4. ğŸŸ¡ æœ‰ä¼˜åŒ–ç©ºé—´ï¼ˆTokené™çº§ã€å…ƒæ•°æ®ç¼“å­˜ã€æ–‡ä»¶æ‹†åˆ†ï¼‰

**ä¼˜å…ˆçº§**:
- ğŸ”´ ä¿®å¤å¹¶å‘ç«æ€ â†’ **ç°åœ¨**
- ğŸŸ¡ ä»£ç é‡æ„ï¼ˆæ‹†åˆ†æ–‡ä»¶ï¼‰ â†’ 1-2å‘¨
- ğŸŸ¢ æ¶æ„ä¼˜åŒ–ï¼ˆä¸Šä¸‹æ–‡ä¼ é€’ï¼‰ â†’ å¯é€‰

**æ€»ä½“è¯„åˆ†**: â­â­â­â­â˜† (4.5/5)
- åŠŸèƒ½å®Œæ•´æ€§: â­â­â­â­â­
- ä»£ç è´¨é‡: â­â­â­â­
- æ€§èƒ½è¡¨ç°: â­â­â­â­â­
- å¯ç»´æŠ¤æ€§: â­â­â­â­
- å®‰å…¨æ€§: â­â­â­â­ (ä¿®å¤ç«æ€åâ†’â­â­â­â­â­)

