# 更新日志 / Changelog

本文档记录 Apple Music Downloader 的所有重要变更。

---

## [未发布] - v1.3.1 (experimental/code-improvements)

### ✨ 新增功能
- **MV 分辨率区间过滤**: 新增 `mv-min` 配置，支持设置 MV 分辨率下限（如 1080p ~ 2160p）
- **配置验证系统**: 新增启动前配置验证，覆盖 40+ 配置项，分为错误和警告两级
- **优雅退出机制**: 支持 Context 取消，Ctrl+C 安全退出批量下载

### 🐛 Bug 修复
- **修复资源泄漏**: 修复 API 客户端中 HTTP 响应体未及时关闭的问题
- **修复 Token 获取**: 适配 Apple Music 网站新结构，恢复自动获取开发者 token 功能
- **修复虚拟 Singles**: 改进合作艺术家单曲识别逻辑，支持 1-3 首曲目专辑

### ⚡ 性能优化
- **并发优化**: 将读多写少的锁从 `Mutex` 升级为 `RWMutex`，提升 2-5 倍读性能
- **资源管理**: 使用闭包立即释放 HTTP 连接，避免文件描述符耗尽

### 🔧 代码改进
- **常量定义**: 将 20+ 处魔法数字提取到 `internal/constants` 包
- **错误处理**: 使用 `%w` 包装错误，保持错误链完整性
- **日志增强**: 添加统一的模块前缀（[API], [虚拟Singles], [工作-休息]），增加调试日志

### 🧪 测试
- **新增单元测试**: 为 `IsSingleAlbum`, `GetPrimaryArtist`, `GetVirtualSinglesTrackNumber` 添加测试
- **测试覆盖**: 核心模块测试覆盖率 > 60%

### 📚 文档
- **整合文档**: 将分散的文档整合到 `docs/` 目录
- **新增开发文档**: `docs/DEVELOPMENT.md` 包含架构、配置、测试指南
- **新增质量报告**: `docs/CODE_QUALITY.md` 记录代码质量改进

---

## [1.3.0] - 2025-11-03

### ✨ 新增功能

#### Singles 虚拟专辑增强
- 支持 1-3 首曲目的专辑自动识别为 Single
- 合作艺术家的单曲作品正确纳入对应艺术家的虚拟 Singles 专辑
- 更智能的单曲识别逻辑

#### 工作-休息循环优化
- 修复了艺术家链接展开后工作-休息循环不生效的问题
- 自动识别批量下载场景并启用循环模式
- 支持长时间批量下载的健康管理

#### 日志系统重大优化
- **错误聚合机制**: 同类错误不再重复刷屏
- **时间限流**: 相同错误最少间隔 3 秒才打印
- **智能提示**: 显示"已发生 X 次"汇总信息
- **效果显著**: 日志输出量减少 85-90%，保留 100% 关键信息

### 🔧 重要修复

#### MV 下载加固
- **文件大小验证**: 防止下载不完整的 MV (<1MB 自动删除)
- **临时文件自动清理**: 使用 defer 机制确保临时文件必定清理
- **视频/音频完整性检查**:
  - 视频文件 < 100KB → 报错
  - 音频文件 < 10KB → 报错
  - 最终 MV < 1MB → 删除并报错
- **增强错误处理**: 专辑中混合曲目和 MV 时更稳定

#### MV 分辨率配置
- 验证并优化了 `mv-max` 配置参数的生效逻辑
- 添加了配置读取的调试信息
- 当找不到符合要求的分辨率时给出明确提示
- 显示实际使用的分辨率信息

### 📚 文档完善
- 在 `config.yaml` 中添加了 CN/US/JP 多账号配置示例
- 说明了不同分区使用不同端口的最佳实践
- 完善了环境变量管理 token 的示例

### 🐛 Bug 修复
1. Singles 虚拟专辑 - 合作艺术家的单曲未归类问题
2. 工作-休息循环 - 艺术家多专辑下载时不生效
3. MV 下载稳定性 - 专辑中 MV 下载高概率报错
4. MV 文件异常 - 部分 MV 只有 1MB 的问题
5. 日志失控 - 重复错误导致日志文件爆炸

### 📊 改进统计
- **修复问题**: 7 个
- **优化功能**: 5 个
- **代码变更**: 约 430 行
- **性能提升**: 日志 I/O 操作减少 85-90%

---

## [1.2.x] - 历史版本

详细历史版本信息请参考 Git 提交记录。

---

## 版本规范

本项目遵循 [语义化版本 2.0.0](https://semver.org/lang/zh-CN/)：

- **主版本号 (MAJOR)**: 不兼容的 API 变更
- **次版本号 (MINOR)**: 向下兼容的功能新增
- **修订号 (PATCH)**: 向下兼容的问题修复

---

## 贡献

欢迎提交 Issue 和 Pull Request！

详细贡献指南请参考 [DEVELOPMENT.md](docs/DEVELOPMENT.md#贡献指南)

