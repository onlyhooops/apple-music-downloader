# Changelog

All notable changes to this project will be documented in this file.

## [v2.8.7] - 2025-10-14

### ✨ 用户界面极简化

#### 全局历史记录检测进度条样式
- ✅ **极简进度显示** - 采用进度条样式显示检测过程，无需显示每个链接详情
- ✅ **智能结果提示** - 根据检测结果显示不同类型的完成消息
- ✅ **统一视觉体验** - 与程序整体UI风格保持一致的极简设计

**改进原理**：
- 使用进度条显示检测进度（如：[10/50]）
- 根据结果智能显示：均已完成、新链接、需重新下载等
- 完全移除冗余的链接详情显示，专注于结果导向

**改进效果**：
- 修复前：显示大量冗长链接信息，界面繁杂
- 修复后：极简进度条样式，信息清晰直观

**界面示例**：
```
🔍 正在对比历史记录
....[10/50]
....[20/50]
....[30/50]
....[40/50]
....[50/50]

🔍 对比完成：均已完成下载
✅ 所有任务都已完成，无需重复下载！
```

**影响文件**：
- `main.go` - 实现极简进度条样式的历史记录检测界面

## [v2.8.5] - 2025-10-14

### 🐛 严重缺陷修复

#### 下载完整性验证机制增强
- ✅ **缓存文件验证** - 在转移缓存文件前验证音乐文件数量，确保下载完整性
- ✅ **严格错误处理** - 下载验证失败时正确清理缓存并返回错误，避免污染目标目录
- ✅ **智能文件计数** - 检查缓存目录中实际的音乐文件数量，至少需要一半歌曲文件才算完整

**修复原理**：
- 在缓存转移前验证缓存目录中的`.m4a`/`.mp3`文件数量
- 只有当音乐文件数量达到预期的一半以上时才转移文件
- 验证失败时清理缓存并返回错误，避免不完整文件转移

**修复效果**：
- 修复前：可能转移只包含封面但缺少音乐文件的不完整缓存
- 修复后：严格验证音乐文件完整性，确保只有完整下载才转移文件

**技术细节**：
- 验证逻辑：`实际音乐文件数 >= 预期歌曲数 / 2`
- 失败处理：清理缓存，返回错误信息，不设置成功标志
- 用户提示：显示缓存验证结果和文件计数统计

**影响文件**：
- `internal/downloader/downloader.go` - 增强缓存验证和错误处理机制

## [v2.8.4] - 2025-10-14

### ✨ 用户体验改进

#### 全局历史记录检测透明化改进
- ✅ **逐个链接透明检查** - 即使所有链接都已完成，也显示每个链接的具体检查过程和状态
- ✅ **详细状态显示** - 为每个链接显示专辑名称和检查原因（已完成、音质变化、新链接等）
- ✅ **准确统计信息** - 提供跳过、音质变化、新链接的准确计数统计

**改进原理**：
- 在全局历史记录检测阶段逐个显示每个链接的检查结果
- 为不同状态的链接使用不同图标（✓ 已完成、🔄 音质变化、➕ 新链接）
- 提供详细的统计摘要，帮助用户理解检测结果

**改进效果**：
- 修复前：简单显示"所有任务都已完成，无需重复下载！"
- 修复后：详细显示每个链接的检查过程和最终统计结果

**改进示例**：
```
📜 全局历史记录检测:
   ✓ https://music.apple.com/... -> Philip Glass: The Complete Piano Etudes (已完成，音质相同)
   🔄 https://music.apple.com/... -> Album Name (音质变化，将重新下载)
   ➕ https://music.apple.com/... -> 新链接

📊 检测结果统计: 跳过 48 个，音质变化 1 个，新链接 1 个
```

**影响文件**：
- `main.go` - 改进全局历史记录检测的用户体验显示

## [v2.8.3] - 2025-10-14

### 🐛 Bug修复

#### 批量任务模式严重缺陷修复
- ✅ **修复缓存转移时机问题** - 确保只有在下载真正成功后才转移缓存文件，避免不完整文件污染目标目录
- ✅ **修复缓存扫描逻辑** - 区分局部错误和全局下载状态，确保缓存机制的正确性
- ✅ **完善失败处理机制** - 下载失败时正确清理缓存，避免残留不完整文件
- ✅ **清理历史遗留问题** - 清理了所有不完整的缓存文件

**修复原理**：
- 缓存转移逻辑移至`downloadSuccess = true`之后，确保只有完整成功的下载才会转移文件
- 延迟清理函数确保下载失败时清理缓存目录
- 全局历史记录检测逻辑保持逐个链接比对，不存在整体TXT跳过问题

**修复效果**：
- 修复前：下载失败时不完整文件仍被转移，污染音乐库
- 修复后：只有完整成功的下载才会转移文件，失败时正确清理缓存

**影响文件**：
- `internal/downloader/downloader.go` - 修复缓存转移时机和扫描逻辑

## [v2.8.2] - 2025-10-13

### 🐛 Bug修复

#### 历史记录跳过逻辑缺陷修复
- ✅ **简化修复逻辑** - 直接比较音质哈希，只要音质参数不同就允许重新下载
- ✅ **统一音质检测** - 移除了复杂的Atmos模式检测逻辑，统一使用音质哈希比较
- ✅ **用户体验优化** - 确保用户可以自由选择下载不同音质版本的专辑

**修复原理**：
- 不同音质参数产生不同音质哈希（例如：普通音质哈希 ≠ Atmos音质哈希）
- 系统检测到音质哈希不同时，允许重新下载
- 用户可以根据需要下载同一专辑的不同音质版本

**修复效果**：
- 修复前：相同URL但不同音质参数会被错误跳过
- 修复后：不同音质参数产生不同哈希，允许重新下载

**影响文件**：
- `main.go` - 简化历史记录跳过逻辑

## [v2.8.1] - 2025-10-13

### 🐛 Bug修复

#### 编译时间戳显示问题修复
- ✅ **修复UTC时间显示问题** - 编译时间戳现在显示本地时间而非UTC时间
- ✅ **统一时间格式** - 确保编译时间与系统时间格式一致
- ✅ **用户体验优化** - 避免用户混淆UTC时间和本地时间

**修复前**：`📅 编译时间: 2025-10-13 15:02:28 UTC`  
**修复后**：`📅 编译时间: 2025-10-13 23:04:37 CST`

**影响文件**：
- `build.sh` - 修改时间戳注入格式
- `main.go` - 简化编译时间显示逻辑

## [v2.8.0] - 2025-10-13

### 🐛 Bug修复

#### 历史记录跳过逻辑缺陷修复
- ✅ **修复相同URL不同音质参数跳过问题** - 解决相同链接但不同音质参数（如普通音质 vs Atmos音质）被错误跳过的缺陷
- ✅ **新增Atmos模式变化检测** - 区分纯链接和带`--atmos`参数的链接，确保可以同时下载同一专辑的普通音质和Atmos音质版本
- ✅ **完善跳过统计信息** - 更新历史记录检测统计，包含音质变化和Atmos模式变化计数
- ✅ **用户体验优化** - 避免用户需要手动绕过历史记录限制即可下载不同音质版本

**修复场景**：
- 用户使用 `url1` 下载普通音质专辑
- 随后使用 `url1 --atmos` 下载同一专辑的Atmos音质版本
- 系统现在能够正确识别这是两个不同的下载任务

**影响文件**：
- `main.go` - 历史记录跳过逻辑和统计信息更新
- `internal/history/history.go` - 历史记录系统优化

## [v2.7.1] - 2025-10-12

### 🐛 Bug修复

#### UI 防抖与显示优化
- ✅ **减少视觉噪音** - 将 UI 刷新间隔从 300ms 增加到 500ms，降低视觉闪烁
- ✅ **状态更新防抖** - 添加 100ms 最小更新间隔，减少无效 UI 更新
- ✅ **速度显示优化** - 修复 `0.0MB/s` 异常显示，低速时不显示速度信息
- ✅ **并发稳定性** - 优化多线程状态更新，避免显示抖动

**影响文件**：
- `internal/ui/ui.go` - UI 刷新间隔和防抖逻辑
- `internal/core/state.go` - 添加时间戳字段
- `internal/ui/formatter.go` - 速度显示优化
- `internal/ui/listener.go` - 格式化逻辑改进

**技术细节**：
- 防抖机制区分重要状态（完成、错误）和普通状态
- 重要状态立即更新，普通状态限制最小间隔 100ms
- 速度 < 10KB/s 时不显示，避免 0.0MB/s 等无意义信息

## [v2.6.0] - 2025-10-11

### 🎉 重大改进

#### 架构重构
本次版本进行了UI与LOG模块的全面重构，解决了长期存在的日志竞争、UI刷新性能等问题。

### ✨ 新增功能

#### 1. 统一日志系统 (internal/logger)
- ✅ 4级日志控制（DEBUG/INFO/WARN/ERROR）
- ✅ 配置化日志输出（stdout/stderr/文件）
- ✅ 时间戳显示控制
- ✅ 线程安全的日志记录

**配置示例**:
```yaml
logging:
  level: info              # debug/info/warn/error
  output: stdout           # stdout/stderr/文件路径
  show_timestamp: false    # UI模式下关闭时间戳
```

#### 2. Progress事件系统 (internal/progress)
- ✅ 观察者模式的事件架构
- ✅ 解耦UI更新与业务逻辑
- ✅ 适配器模式实现平滑迁移
- ✅ 支持多个监听器扩展

#### 3. UI智能简化与优化 (internal/ui)
- ✅ 自适应终端宽度显示（FullMode/CompactMode/MinimalMode）
- ✅ 智能简化长曲目名称和质量信息
- ✅ 优化进度条和状态指示器
- ✅ 修复UI渲染错位和行覆盖问题

### 🐛 Bug修复

#### 元数据修复
- ✅ **专辑元数据音质标签** - Album和AlbumSort字段现在包含音质标签（如"Head Hunters Hi-Res Lossless"）
  - 修复音乐管理软件无法区分同一专辑不同音质版本的问题
  - 影响所有音质类型：Alac/Hi-Res Lossless/Dolby Atmos/Aac 256

#### UI修复
- ✅ **日志重复问题** - 修复logger输出干扰UI光标定位（重定向logger到stderr）
- ✅ **UI渲染错位** - 修复长曲目名称导致的行覆盖和滚动问题
- ✅ **进度更新优化** - 减少不必要的UI刷新，提升性能

### 🔧 配置变更

#### 新增配置项
```yaml
# 日志配置
logging:
  level: info
  output: stdout
  show_timestamp: false

# 工作-休息循环（仅批量模式生效）
work-rest-enabled: false
work-duration-minutes: 5
rest-duration-minutes: 1
```

### 📚 技术改进

#### 代码质量
- ✅ 系统化替换 fmt.Print 为 logger 调用
- ✅ 移除 UI 直接调用，使用事件驱动架构
- ✅ 完整的单元测试覆盖（logger + progress）
- ✅ 并发安全性验证（go test -race）

#### 性能优化
- ✅ 减少UI刷新频率（200ms → 智能刷新）
- ✅ 优化logger性能（支持高并发）
- ✅ 改进进度事件分发效率

### 🚧 已知问题

无重大已知问题。

### 📝 升级说明

1. **配置文件更新**：请参考 `config.yaml.example` 添加新的 `logging` 配置项
2. **元数据更新**：新下载的文件会自动包含音质标签，旧文件不受影响
3. **UI体验**：动态UI现在更稳定，支持 `--no-ui` 禁用动态UI回退到日志模式

---

## [v2.5.0] - 2025-10-10

### 🎯 元数据与命名规范完善

#### 核心功能

##### 1. 专辑元数据音质标签修复
- ✅ **Album 和 AlbumSort 字段音质标签** - 为元数据中的 ALBUM 和 ALBUMSORT 字段添加音质标签
- ✅ **修复音乐管理软件识别问题** - 确保同一专辑的不同音质版本能被正确识别
- ✅ **影响所有音质类型** - Alac / Hi-Res Lossless / Dolby Atmos / Aac 256 全部支持
- ✅ **兼容主流音乐管理软件** - iTunes / Plex / Emby / Jellyfin 等完美支持

**示例效果：**
```
文件夹: Head Hunters Hi-Res Lossless/
元数据: ALBUM = "Head Hunters Hi-Res Lossless"
        ALBUMSORT = "Head Hunters Hi-Res Lossless"
```

##### 2. 统一命名规范
- ✅ **专辑文件夹命名** - 使用 `{AlbumName} {Tag}` 格式，末尾添加音质标签
- ✅ **曲目元数据命名** - Album 字段同步包含音质标签
- ✅ **完整性保证** - 文件夹名称和元数据保持一致

#### 应用场景

**适用情况：**
- 📚 管理多音质版本的音乐库（同一专辑的 Alac/Atmos/Hi-Res 版本）
- 🎵 使用 Plex/Emby/Jellyfin 等音乐服务器
- 💿 需要精确区分专辑版本的收藏者
- 🔍 需要通过元数据搜索特定音质版本

**解决的问题：**
- ❌ 之前：音乐管理软件将不同音质版本识别为同一专辑
- ✅ 现在：每个音质版本独立显示，元数据完整区分

#### 技术实现

##### 元数据写入逻辑
三种情况下都添加音质标签：
1. **播放列表模式（不使用歌曲信息）**
   ```
   Album = PlaylistName + " " + QualityTag
   ```
2. **播放列表模式（使用歌曲信息）**
   ```
   Album = OriginalAlbumName + " " + QualityTag
   ```
3. **普通专辑模式**
   ```
   Album = AlbumName + " " + QualityTag
   ```

##### 音质标签格式
- `Alac` - ALAC 无损格式
- `Hi-Res Lossless` - 高解析度无损（24-bit）
- `Dolby Atmos` - 杜比全景声
- `Aac 256` - AAC 256kbps

### 🔧 版本管理系统

#### 新增功能
- ✅ **VERSION 文件** - 独立的版本号文件，便于版本追踪
- ✅ **版本号格式** - 遵循语义化版本规范（Semantic Versioning）

### 📝 升级说明

#### 从 v2.2.0 升级到 v2.5.0

1. **无需配置更改** - 所有功能自动启用
2. **元数据自动更新** - 新下载的文件自动包含音质标签
3. **向后兼容** - 不影响已下载的文件

#### 重新下载建议

如果需要为旧文件添加音质标签：
```bash
# 使用提供的元数据修复脚本（需要自行编写或使用工具）
# 或者重新下载特定专辑
./apple-music-downloader <album-url>
```

### 🚧 已知限制

- 旧文件不会自动更新元数据
- 需要手动处理或重新下载以获得新格式

---

## [v2.2.0] - 2025-10-09

### ✨ New Features

#### 🔧 日志与UI治理方案
- **全局OutputMutex + SafePrintf封装** - 解决输出交织和光标错位问题
- **--no-ui 开关** - 支持纯日志输出模式，适合CI/调试环境
- **UI Suspend/Resume API** - 交互式输入时暂停UI更新，避免冲突

#### 🎵 音频与视频增强
- **MV下载Emby兼容路径** - 完全符合Emby/Jellyfin媒体服务器命名规范
- **音质标签统一处理** - `FormatQualityTag()` 统一所有质量标签格式化
- **独立MV保存路径** - 支持 `mv-save-folder` 配置

#### 💡 用户体验优化
- **交互式文件检查** - 检测到文件已存在时询问是否校验
- **智能提示信息** - 区分"文件转移完成"和"校验完成"
- **改进的统计输出** - 简化格式，修复换行符问题

### ⚡ Performance

#### 🚀 缓存中转机制 (v1.1.0+)
- **下载速度提升 50-70%** - 针对NFS等网络文件系统优化
- **网络I/O减少 90%+** - 本地处理后批量传输
- **原子性保证** - 失败自动回滚，不留垃圾文件

**配置示例：**
```yaml
enable-cache: true
cache-folder: "./Cache"
```

### 🐛 Bug Fixes

#### 缓存机制修复
- **修复缓存跳过已下载文件问题** (v1.1.1) - 智能检查最终目标路径
- **修复ffmpeg检测路径错误** (v1.1.2) - 区分工作路径和返回路径

#### 输出优化
- **修复统计输出缺少换行符** - 解决shell提示符显示异常
- **简化统计输出格式** - 移除书名号，提升可读性

### 📚 Documentation

#### 新增文档
- `CACHE_MECHANISM.md` - 完整缓存机制技术文档
- `QUICKSTART_CACHE.md` - 缓存快速开始指南
- `CACHE_UPDATE.md` - 缓存更新说明
- `CHANGELOG.md` - 版本变更日志（本文档）

#### 更新文档
- `README.md` - 全面更新功能说明和使用指南
- `README-CN.md` - 中文文档同步更新
- `config.yaml.example` - 添加新配置项说明

### 🔧 Configuration Changes

#### 新增配置项
```yaml
# 缓存中转机制
enable-cache: true
cache-folder: "./Cache"

# MV保存路径
mv-save-folder: "/media/Music/AppleMusic/MusicVideos"

# 专辑和文件命名格式
album-folder-format: "{AlbumName} {Tag}"
song-file-format: "{SongNumer}. {SongName}"
artist-folder-format: "{ArtistName}"
playlist-folder-format: "{PlaylistName}"
```

### 📊 Performance Benchmarks

#### 测试场景：Hi-Res专辑（12首）

| 指标 | 未启用缓存 | 启用缓存 | 提升 |
|------|-----------|---------|------|
| 下载时间 | 510秒 | 190秒 | **63%** |
| 网络请求 | 450次 | 15次 | **97%** |

---

## [v2.1.0] - 2025-10-09

### ✨ Features
- 缓存中转机制初始实现
- MV下载Emby兼容路径
- 音质标签统一处理机制

### 🐛 Fixes
- 多项性能优化和稳定性改进

---

## [v2.0.0-logger-system] - 2025-10-09

### ✨ Features
- 统一日志系统重构
- 静态展示和固定位置刷新
- 解决并发竞争问题

---

## [v1.x] - Earlier Versions

### Core Features
- ALAC/Dolby Atmos/Hi-Res Lossless 下载
- 内嵌封面和LRC歌词
- 逐词与未同步歌词支持
- 歌手专辑批量下载
- MV下载功能
- 交互式搜索
- FFmpeg自动修复
- 多账号轮换
- TXT批量下载

---

## Upgrade Guide

### From v2.1.0 to v2.2.0

1. **更新配置文件**
   ```bash
   # 备份现有配置
   cp config.yaml config.yaml.backup
   
   # 添加新配置项（可选）
   # 参考 config.yaml.example
   ```

2. **启用缓存机制**（推荐用于NFS）
   ```yaml
   enable-cache: true
   cache-folder: "./Cache"
   ```

3. **使用新的输出模式**
   ```bash
   # 动态UI（默认）
   ./apple-music-downloader <url>
   
   # 纯日志模式
   ./apple-music-downloader --no-ui <url>
   ```

### Breaking Changes

**无破坏性变更** - 所有新功能都是可选的，向后兼容。

---

## Known Issues

### Current Limitations
- 缓存机制需要额外磁盘空间（建议50GB+）
- 动态UI在某些终端上可能显示异常（使用`--no-ui`解决）
- 翻译和发音歌词功能仍在Beta阶段

### Workarounds
- NFS慢速问题 → 启用缓存机制
- UI显示混乱 → 使用 `--no-ui` 标志
- 编码问题 → 启用 `ffmpeg-fix`

---

## Future Plans

### v2.3.0 (计划中)
- [ ] 缓存大小限制和自动清理
- [ ] 缓存统计信息面板
- [ ] 更多音质格式支持

### v3.0.0 (长期)
- [ ] Web UI 界面
- [ ] 分布式缓存支持
- [ ] 插件系统

---

## Credits

- **Sorrow** - Original script author
- **chocomint** - Created `agent-arm64.js`
- **Sendy McSenderson** - Stream decryption code
- All contributors and testers

---

**Note:** This changelog follows [Keep a Changelog](https://keepachangelog.com/en/1.0.0/) format and uses [Semantic Versioning](https://semver.org/).

